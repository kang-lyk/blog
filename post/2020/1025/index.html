<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
<title>mock.js&#43;koa2作一个简单的mockServe - 枯木逢春犹再发，人无两度再少年</title>
<meta name="description"
    content="">


<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">


<link rel="stylesheet" href="https://kang-lyk.github.io/blog/css/normalize.css">

<link rel="stylesheet" href="https://kang-lyk.github.io/blog/css/skeleton.css">

<link rel="stylesheet" href="https://kang-lyk.github.io/blog/css/custom.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>




</head>
    <body><nav>
    <label for="drop" class="toggle"><i class="fas fa-bars u-pull-right" aria-hidden="true"></i> <span><i
                class="fas fa-fire" aria-hidden="true"></i>
            枯木</span></label>
    <input type="checkbox" id="drop" />
    <ul class="menu">
        <li><a href="https://kang-lyk.github.io/blog/"><span><i class="fas fa-fire" aria-hidden="true"></i>
                    枯木</span></a></li>
        
        <li class="u-pull-right">
            <a href="https://kang-lyk.github.io/blog/post" class="Members">
                <span> 博文</span>
            </a>
        </li>
        
        <li class="u-pull-right">
            <a href="https://kang-lyk.github.io/blog/" class="Members">
                <span> 首页</span>
            </a>
        </li>
        
    </ul>
</nav>

<div class="section hero">
    <div class="container">
        <h1 class="section-heading">mock.js&#43;koa2作一个简单的mockServe</h1>
        
        
        
        <i class="far fa-calendar"></i> Published On: 2020-10-25,
        <i class="far fa-clock"></i> Reading Time: 2 minutes
        </h6>
    </div>
</div>

<div class="section main">
    <div class="row content">
        <article>
            <p><a href="http://mockjs.com/">mock.js</a>是阿里出品的有于拦截AJAX接口请求生成随机数据的库。在已提供接口文档的情况下，用<code>mock.js</code>生接口请求数据，而不用等待服务端的同伙给测试接口，方便并行开发。</p>
<p>以前在研究 ant-design pro时发现它所使用的<code>react</code>角手架<code>DvaJS</code>支持<code>mock.js</code>（现在推荐使用<a href="https://umijs.org/zh-CN">Umi</a>），</p>
<p>在<code>mock</code>目录编辑文件如 /mock/api.js 的内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> {
  <span style="color:#75715e">// 支持值为 Object 和 Array
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#39;GET /api/users&#39;</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">users</span><span style="color:#f92672">:</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>] },

  <span style="color:#75715e">// GET 可忽略
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#39;/api/users/1&#39;</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> },

  <span style="color:#75715e">// 支持自定义函数，API 参考 express@4
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#39;POST /api/users/create&#39;</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
    <span style="color:#75715e">// 添加跨域请求头
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">setHeader</span>(<span style="color:#e6db74">&#39;Access-Control-Allow-Origin&#39;</span>, <span style="color:#e6db74">&#39;*&#39;</span>);
    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">end</span>(<span style="color:#e6db74">&#39;ok&#39;</span>);
  }
}
</code></pre></div><p>然后访问 <code>/api/users</code> 就能得到 <code>{ users: [1,2] }</code> 的响应。</p>
<p><code>vue</code>版本的<code>ant-design</code>是没有<code>Umi</code>这样的角手架，只能用<code>vue-cli</code>了。<code>vue-cli</code>可不是阿里的，没有自带mock.js。</p>
<p>当然这并不影响我们把mock.js加入进去。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">//vue.config.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;./mock&#39;</span>)
{
  <span style="color:#a6e22e">devServer</span><span style="color:#f92672">:</span> {
    <span style="color:#75715e">// 环境变量MOCK决定是否开启MOCK
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">before</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">MOCK</span> <span style="color:#f92672">?</span> <span style="color:#a6e22e">mock</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>
  }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// mock/index.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Mock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;mockjs&#39;</span>)
<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">app</span>) =&gt; {
  <span style="color:#a6e22e">app</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;/apiuserInfo/&#39;</span>, (<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">res</span>) =&gt; {
    <span style="color:#75715e">// 生成随机数据
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">resData</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Mock</span>.<span style="color:#a6e22e">mock</span>({
      <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
      <span style="color:#a6e22e">userName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@cname&#39;</span>,
      <span style="color:#a6e22e">age</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">34</span>,
      <span style="color:#a6e22e">portrait</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@image(&#34;250x250&#34;, &#34;FF6600&#34;, &#34;P&#34;)&#39;</span>
    })
    <span style="color:#a6e22e">res</span>.<span style="color:#a6e22e">json</span>(<span style="color:#a6e22e">resData</span>)
  })
}
</code></pre></div><p><code>mock/index.js</code>中的函数还可以更优化一下。但我想把mock独立出来不放到项目中，顺便用一下<a href="https://koa.bootcss.com/">koa2</a>来代替<a href="http://expressjs.com/">Express</a>。支持Umi的mock.js一样写法。</p>
<h2 id="安装所需的工具">安装所需的工具</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">yarn</span> <span style="color:#a6e22e">add</span> <span style="color:#a6e22e">koa</span> <span style="color:#a6e22e">koa</span><span style="color:#f92672">-</span><span style="color:#a6e22e">bodyparser</span> <span style="color:#a6e22e">koa</span><span style="color:#f92672">-</span><span style="color:#a6e22e">router</span> <span style="color:#a6e22e">mockjs</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">S</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">yarn</span> <span style="color:#a6e22e">add</span> <span style="color:#a6e22e">pm2</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">g</span>
</code></pre></div><ul>
<li>koa2 web开发框架</li>
<li>koa-router 路由中间件</li>
<li>koa-bodyparser 将post请求的参数转为json格式</li>
<li>mock.js 生成随机数据</li>
<li>pm2 零秒重启项目，再也不用改一次代码重启一试了</li>
</ul>
<h2 id="开始开发">开始开发</h2>
<p>目标是在目录<code>/mock/</code>中添有指定格式的js文件就是生成接口。前添加一个useData.js</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">Mock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;mockjs&#39;</span>)

<span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
<span style="color:#75715e">// 登录
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;POST /api/login&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">response</span>) =&gt; {
        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">body</span>);
        <span style="color:#66d9ef">const</span> {
            <span style="color:#a6e22e">body</span><span style="color:#f92672">:</span> {
                <span style="color:#a6e22e">username</span>,
                <span style="color:#a6e22e">password</span>    
            }
        } <span style="color:#f92672">=</span> <span style="color:#a6e22e">request</span>
        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">username</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;admin&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">password</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;123456&#39;</span>) {
            <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Mock</span>.<span style="color:#a6e22e">mock</span>({
                <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
                <span style="color:#a6e22e">userName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@cname&#39;</span>,
                <span style="color:#a6e22e">token</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@string(30)&#39;</span>,
                <span style="color:#a6e22e">portrait</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@image(&#34;250x250&#34;, &#34;FF6600&#34;, &#34;P&#34;)&#39;</span>
            })    
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">JSON</span>.<span style="color:#a6e22e">stringify</span>({
                <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100001</span>,
                <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;账号和密码错误&#39;</span>
            })
        }
    },
    <span style="color:#75715e">// 用户信息
</span><span style="color:#75715e"></span>    <span style="color:#e6db74">&#39;GET /api/userInfo&#39;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">response</span>) =&gt; {
        <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">set</span>({
            <span style="color:#e6db74">&#39;Access-Control-Allow-Origin&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;*&#39;</span>
        })
        <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">Mock</span>.<span style="color:#a6e22e">mock</span>({
            <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
            <span style="color:#a6e22e">userName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@cname&#39;</span>,
            <span style="color:#a6e22e">age</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">34</span>,
            <span style="color:#a6e22e">portrait</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;@image(&#34;250x250&#34;, &#34;FF6600&#34;, &#34;P&#34;)&#39;</span>
        })
    }
}
</code></pre></div><p>新建入口文件main.js</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">//main.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">koa</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;koa&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">router</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;koa-router&#39;</span>)()
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bodyParser</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;koa-bodyparser&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">app</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">koa</span>()
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;fs&#39;</span>)
<span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">log</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;console&#39;</span>)
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">mockFiles</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">readdirSync</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">__dirname</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/mock`</span>)

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">allRouterObj</span> <span style="color:#f92672">=</span> {}
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">jsFilesName</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">mockFiles</span>) {
<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">item</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">__dirname</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/mock/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">jsFilesName</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>)
    <span style="color:#a6e22e">allRouterObj</span> <span style="color:#f92672">=</span> {...<span style="color:#a6e22e">allRouterObj</span>, ...<span style="color:#a6e22e">item</span>}
}

<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">allRouterMode</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">keys</span>(<span style="color:#a6e22e">allRouterObj</span>)
<span style="color:#a6e22e">allRouterMode</span>.<span style="color:#a6e22e">forEach</span>(<span style="color:#a6e22e">element</span> =&gt; {
    <span style="color:#66d9ef">let</span> [<span style="color:#a6e22e">mode</span>, <span style="color:#a6e22e">apiPath</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">element</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#39; &#39;</span>)
    <span style="color:#a6e22e">mode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">mode</span>.<span style="color:#a6e22e">toLowerCase</span>()
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">routerBody</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">allRouterObj</span>[<span style="color:#a6e22e">element</span>]
    <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">typeof</span> <span style="color:#a6e22e">routerBody</span> <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;function&#39;</span>) {
        <span style="color:#a6e22e">router</span>[<span style="color:#a6e22e">mode</span>](<span style="color:#a6e22e">apiPath</span>, <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
            <span style="color:#66d9ef">let</span> {<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">response</span>} <span style="color:#f92672">=</span> <span style="color:#a6e22e">ctx</span>
            <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">routerBody</span>(<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">response</span>)
            <span style="color:#a6e22e">next</span>()
        })
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">router</span>[<span style="color:#a6e22e">mode</span>](<span style="color:#a6e22e">apiPath</span>, <span style="color:#a6e22e">async</span> (<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">next</span>) =&gt; {
            <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">url</span>)
            <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">body</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">routerBody</span>
            <span style="color:#a6e22e">next</span>()
        })
    }
});

<span style="color:#a6e22e">app</span>
    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">bodyParser</span>())
    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">routes</span>())
    .<span style="color:#a6e22e">use</span>(<span style="color:#a6e22e">router</span>.<span style="color:#a6e22e">allowedMethods</span>())
    .<span style="color:#a6e22e">listen</span>(<span style="color:#ae81ff">3000</span>)
</code></pre></div><p>修改package.json的script</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;scripts&#34;</span>: {
    <span style="color:#f92672">&#34;start&#34;</span>: <span style="color:#e6db74">&#34;node app.js&#34;</span>,
    <span style="color:#f92672">&#34;pm2&#34;</span>: <span style="color:#e6db74">&#34;pm2 start app.js --watch&#34;</span>
  }
}
</code></pre></div><p>运行命令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yarn pm2
</code></pre></div><p>或者</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm run pm2
</code></pre></div><p>浏览器访问http://localhost:3000/api/userInfo 就看到想要的数据了。</p>
<h2 id="设置代理">设置代理</h2>
<p>就算是本地开发环境如果我们直接访问不同端口的接口同样会碰到跨域问题。我用的是vue-cli搭建的项目，可以修改一下配置解决问题</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#75715e">// vue.config.js
</span><span style="color:#75715e"></span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> {
  <span style="color:#a6e22e">devServer</span><span style="color:#f92672">:</span> {
      <span style="color:#a6e22e">allowedHosts</span><span style="color:#f92672">:</span> [
        <span style="color:#e6db74">&#39;192.x.x.1xx:3000&#39;</span>
      ],
      <span style="color:#a6e22e">proxy</span><span style="color:#f92672">:</span> {
        <span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">:</span> {
          <span style="color:#75715e">// target: process.env.VUE_APP_LOCAL_APIURL,
</span><span style="color:#75715e"></span>          <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;192.x.x.1xx:3000&#39;</span>,
          <span style="color:#a6e22e">secure</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>
        }
      }
    }
}
</code></pre></div><p>跨域问题是浏览器与服务端之前的问题，设置代理之后由要地服务请求到数据再发给浏览器自然没问题了。但建议<code>target</code>的值设置在环境变量中然后用<code>process.env</code>调用会更好。</p>
<p><a href="https://github.com/kang-lyk/mockServe">项目源码</a></p>

            
        </article>
    </div>
</div>

<footer>
    <span class="copyright">
         &copy; 2021 
        <a href="https://github.com/aanupam23/hugo-sugoi" title="hugo-sugoi" alt="hugo-sugoi" target="_blank">Hugo-Sugoi</a>
    </span>
</footer></body>
</html>
